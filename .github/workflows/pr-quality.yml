name: PR Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    name: Informations PR
    runs-on: ubuntu-latest
    
    steps:
      - name: PR Info
        run: |
          echo "ğŸ” PR #${{ github.event.pull_request.number }}"
          echo "ğŸ“ Titre: ${{ github.event.pull_request.title }}"
          echo "ğŸ‘¤ Auteur: ${{ github.event.pull_request.user.login }}"
          echo "ğŸ¯ Branche source: ${{ github.event.pull_request.head.ref }}"
          echo "ğŸ¯ Branche cible: ${{ github.event.pull_request.base.ref }}"
          echo "ğŸ“Š Fichiers modifiÃ©s: ${{ github.event.pull_request.changed_files }}"
          echo "â• Additions: ${{ github.event.pull_request.additions }}"
          echo "â– Suppressions: ${{ github.event.pull_request.deletions }}"

  pr-size-labeler:
    name: LabÃ©liser taille PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
      - name: Calculer la taille de la PR
        id: size
        run: |
          changes=${{ github.event.pull_request.additions }}
          
          if [ $changes -lt 50 ]; then
            echo "label=size/XS" >> $GITHUB_OUTPUT
          elif [ $changes -lt 200 ]; then
            echo "label=size/S" >> $GITHUB_OUTPUT
          elif [ $changes -lt 500 ]; then
            echo "label=size/M" >> $GITHUB_OUTPUT
          elif [ $changes -lt 1000 ]; then
            echo "label=size/L" >> $GITHUB_OUTPUT
          else
            echo "label=size/XL" >> $GITHUB_OUTPUT
          fi
      
      - name: Ajouter label
        uses: actions/github-script@v7
        with:
          script: |
            const label = '${{ steps.size.outputs.label }}';
            
            // RÃ©cupÃ©rer les labels actuels
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // Supprimer les anciens labels de taille
            const sizeLabels = currentLabels.filter(l => l.name.startsWith('size/'));
            for (const oldLabel of sizeLabels) {
              if (oldLabel.name !== label) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: oldLabel.name,
                });
              }
            }
            
            // Ajouter le nouveau label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label],
            });

  check-pr-title:
    name: VÃ©rifier titre PR
    runs-on: ubuntu-latest
    
    steps:
      - name: VÃ©rifier le format du titre
        run: |
          title="${{ github.event.pull_request.title }}"
          
          # VÃ©rifier si le titre suit le format conventional commits
          if echo "$title" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+"; then
            echo "âœ… Titre valide: $title"
          else
            echo "âš ï¸ Le titre devrait suivre le format: type(scope): description"
            echo "Exemples:"
            echo "  - feat(api): add user authentication"
            echo "  - fix(db): resolve connection timeout"
            echo "  - docs: update installation guide"
            echo ""
            echo "Types valides: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
          fi

  check-description:
    name: VÃ©rifier description PR
    runs-on: ubuntu-latest
    
    steps:
      - name: VÃ©rifier la prÃ©sence d'une description
        run: |
          description="${{ github.event.pull_request.body }}"
          
          if [ -z "$description" ] || [ "$description" = "null" ]; then
            echo "âš ï¸ Aucune description fournie"
            echo "ğŸ’¡ Pensez Ã  ajouter:"
            echo "  - Une description des changements"
            echo "  - Les raisons de ces changements"
            echo "  - Les tests effectuÃ©s"
            exit 0
          else
            echo "âœ… Description prÃ©sente"
            echo "Longueur: $(echo "$description" | wc -c) caractÃ¨res"
          fi

  detect-breaking-changes:
    name: DÃ©tecter breaking changes
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: VÃ©rifier les breaking changes
        id: breaking
        run: |
          title="${{ github.event.pull_request.title }}"
          body="${{ github.event.pull_request.body }}"
          
          has_breaking=false
          
          # VÃ©rifier dans le titre
          if echo "$title" | grep -qi "BREAKING CHANGE"; then
            has_breaking=true
          fi
          
          # VÃ©rifier dans la description
          if echo "$body" | grep -qi "BREAKING CHANGE"; then
            has_breaking=true
          fi
          
          # VÃ©rifier les fichiers critiques modifiÃ©s
          if git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -q "docker-compose.yml\|.env.example\|requirements.txt"; then
            echo "âš ï¸ Fichiers critiques modifiÃ©s - peut contenir des breaking changes"
          fi
          
          echo "has_breaking=$has_breaking" >> $GITHUB_OUTPUT
      
      - name: Ajouter label breaking change
        if: steps.breaking.outputs.has_breaking == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['breaking-change'],
            });

  comment-guidelines:
    name: Commentaire de bienvenue
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    if: github.event.action == 'opened'
    
    steps:
      - name: Commenter la PR
        uses: actions/github-script@v7
        with:
          script: |
            const message = `ğŸ‘‹ Merci pour votre contribution Ã  Kiwi-DB !
            
            ## ğŸ” Checklist de revue
            
            Avant de fusionner cette PR, assurez-vous que:
            
            - [ ] Le code respecte les standards du projet
            - [ ] Les tests passent (vÃ©rifiez l'onglet "Checks")
            - [ ] La documentation est Ã  jour si nÃ©cessaire
            - [ ] Les changements ont Ã©tÃ© testÃ©s localement
            - [ ] Le titre suit le format conventional commits
            
            ## ğŸ¤– Actions automatiques
            
            Les workflows suivants s'exÃ©cutent automatiquement:
            - âœ… **CI**: Tests, linting, et validation
            - ğŸ³ **Docker**: Build des images
            - ğŸ”’ **Security**: Scan de vulnÃ©rabilitÃ©s
            
            ## ğŸ“ Bonnes pratiques
            
            - Gardez les PR petites et focalisÃ©es
            - Utilisez des commits atomiques avec des messages clairs
            - RÃ©pondez aux commentaires de revue
            - Mettez Ã  jour la PR si la branche cible change
            
            Bon dÃ©veloppement ! ğŸš€`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message,
            });
