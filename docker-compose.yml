# Docker Compose configuration for the application stack
#version: '3.8'

services:
  ######################################################
  #                  FRONTEND OPEN WEB UI              #
  ######################################################
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "3000:8080"
    environment:
      - 'OLLAMA_BASE_URL=http://orchestrator:8000'
    volumes:
      - open-webui-data:/app/backend/data
    networks:
      - query_network
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      - orchestrator

  ######################################################
  #                   ORCHESTRATOR LLM                 #
  ######################################################
  orchestrator:
    build: ./orchestrateur
    container_name: orchestrator
    restart: always
    environment:
      MCP_GATEWAY_URL: ws://mcp-gateway:9000
    networks:
      - query_network
      - bdd_network
  
  query-management:
    build: ./query-management
    container_name: query-management
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "5000:5000"
    environment:
      ORCHESTRATOR_URL: http://orchestrator:8000
    depends_on:
      - orchestrator
    networks:
      - query_network
  
  ######################################################
  #                     MCP GATEWAY                    #
  ######################################################
 
  # MCP Gateway

  ######################################################
  #                SERVEURS MCP (DB CONNECTORS)        #
  ######################################################
  # Postgres MCP Server
  mcp-postgres:
    image: mcp/postgres
    container_name: mcp-postgres
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - POSTGRES_URL=${POSTGRES_URL}
      - MCP_PORT=7000
    expose:
      - "7000"
    networks:
      - bdd_network

  ######################################################
  #                BASES DE DONNÉES RÉELLES            #
  ######################################################
  postgres:
    image: postgres:16
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - bdd_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  ######################################################
  # SEEDER (génère les données au premier lancement) #
  ######################################################

  postgres_data:
    build: ./postgres
    command: ["python", "download_BDD.py"]
    env_file:
      - .env
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - bdd_network

########################################################
#                       RÉSEAUX                         #
########################################################
networks:
  query_network:
    driver: bridge
  bdd_network:
    driver: bridge

########################################################
#                      VOLUMES                          #
########################################################
volumes:
  postgres_data:
    driver: local
  open-webui-data:
    driver: local
