# Docker Compose configuration for the application stack
#version: '3.8'

services:

  ######################################################
  # NGINX REVERSE PROXY + SSL TERMINATION
  ######################################################
  nginx:
    build: ./nginx
    container_name: nginx-reverse-proxy
    restart: unless-stopped
    ports:
      - "80:80"      # HTTP (redirigé vers HTTPS)
      - "443:443"    # HTTPS (principal)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/letsencrypt/live/certs:rw
      - ./nginx/logs:/var/log/nginx
    networks:
      - query_network
    depends_on:
      - open-webui
      - query-management
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  ######################################################
  #                  FRONTEND OPEN WEB UI              #
  ######################################################
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: unless-stopped
    environment:
      - 'OLLAMA_BASE_URL=http://orchestrator:8000'
    volumes:
      - open-webui-data:/app/backend/data
    networks:
      - query_network
    dns:
      - 8.8.8.8
      - 8.8.4.4
    depends_on:
      - orchestrator

  ######################################################
  #                   ORCHESTRATOR LLM                 #
  ######################################################
  orchestrator:
    build: ./orchestrateur
    container_name: orchestrator
    restart: always
    environment:
      MCP_GATEWAY_URL: ws://mcp-gateway:9000
    networks:
      - query_network
      - bdd_network
  
  query-management:
    build: ./query-management
    container_name: query-management
    restart: unless-stopped
    env_file:
      - .env.dev
    ports:
      - "220:220"
    environment:
      ORCHESTRATOR_URL: http://orchestrator:8000
    depends_on:
      - orchestrator
    networks:
      - query_network
  
  ######################################################
  #                     MCP GATEWAY                    #
  ######################################################
  mcp-gateway:
    build: ./mcp/mcp-gateway
    container_name: mcp-gateway
    restart: always
    ports:
      - "9000:9000"
    networks:
      - query_network
      - bdd_network
    depends_on:
      - mcp-postgres

  ######################################################
  #                SERVEURS MCP (DB CONNECTORS)        #
  ######################################################
  # Postgres MCP Server (CrystalDBA Pro)
  mcp-postgres:
    image: crystaldba/postgres-mcp
    container_name: mcp-postgres
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .env.dev
    command:
      - "--access-mode=unrestricted"
      - "--transport=sse"
      - "--sse-host=0.0.0.0"
      - "--sse-port=8000"
    ports:
      - "8000:8000"
    networks:
      - bdd_network
  mcp-mongo:
    image: node:20-alpine
    container_name: mcp-mongo
    restart: unless-stopped
    depends_on:
      - mongo
    environment:
      # URI correspondant à ton service 'mongo' défini plus bas
      - MONGO_URI=mongodb://root:example@mongo:27017/?authSource=admin
    # On utilise supergateway pour convertir le serveur officiel (stdio) en serveur SSE sur le port 8001
    command: >
      sh -c "npm install -g supergateway mongodb-mcp-server &&
      supergateway --port 8001 --stdio 'npx mongodb-mcp-server ${MONGO_URI}'"
    ports:
      - "8001:8001"
    networks:
      - bdd_network
  ######################################################
  #                   POSTGRES-PGVECTOR                #
  ######################################################
  postgres-pgvector:
    build:
      context: ./DataBase/postgres-pgvector
    container_name: postgres-pgvector
    restart: unless-stopped
    env_file:
      - .env.dev
    volumes:
      - pgdata_pgvector:/var/lib/postgresql/data
      - ./DataBase/postgres-pgvector/dataset_droit_travail.sql:/docker-entrypoint-initdb.d/03-droit-travail-data.sql
    ports:
      - "5432:5432"
    networks:
      - bdd_network

  ######################################################
  #                BASES DE DONNÉES RÉELLES            #
  ######################################################
  postgres:
    image: postgres:16
    restart: unless-stopped
    env_file:
      - .env.dev
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./DataBase/postgres:/docker-entrypoint-initdb.d
    networks:
      - bdd_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
      interval: 10s
      timeout: 5s
      retries: 5

  ######################################################
  # SEEDER (génère les données au premier lancement) #
  ######################################################

  ######################################################
  #                      MONGODB                      #
  ######################################################
  mongo:
    image: mongo:6.0
    container_name: mongo
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
      MONGO_INITDB_DATABASE: safety_db
    volumes:
      - mongo_data:/data/db
      - ./DataBase/mongo/mongo-init:/docker-entrypoint-initdb.d
    ports:
      - "27017:27017"
    networks:
      - bdd_network

  ######################################################
  #                  MONGO DATA LOADER                 #
  ######################################################
  mongo-loader:
    build:
      context: ./DataBase/mongo/mongo-loader
    container_name: mongo-loader
    depends_on:
      - mongo
    environment:
      MONGO_URI: mongodb://root:example@mongo:27017
      MONGO_DB: safety_db
      MONGO_COLLECTION: procedures
    networks:
      - bdd_network
    restart: 'no'

########################################################
#                       RÉSEAUX                         #
########################################################
networks:
  query_network:
    driver: bridge
  bdd_network:
    driver: bridge

########################################################
#                      VOLUMES                          #
########################################################
volumes:
  postgres_data:
  mongo_data:
  pgdata_pgvector:
    driver: local
  open-webui-data:
